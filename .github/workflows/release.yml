# GitHub Actions workflow for automated semantic versioning and releases.
# This workflow analyzes commit messages to determine version bumps and creates releases.
# Integrates with GoReleaser to build and publish cross-platform binaries.

name: Release

# Trigger on pushes to master branch and allow manual triggering.
# Only master branch pushes should trigger releases in production.
on:
  push:
    branches: [master] # Automated releases on master branch pushes.
  workflow_dispatch: {} # Allow manual release triggering when needed.

# Grant write permissions to create releases and push tags.
permissions:
  contents: write # Required to create releases and push Git tags.

jobs:
  release:
    runs-on: ubuntu-latest # Use Ubuntu for consistent tooling environment.
    steps:
      # Check out repository with full Git history for version analysis.
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Fetch all tags and history for semantic versioning.

      # Set up Go environment for building release binaries.
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "stable" # Use latest stable Go version.
          cache: true

      # Analyze commit messages since last tag to determine version bump.
      # Uses the semver_next.sh script to implement semantic versioning logic.
      # Fetch latest tags first to ensure accurate version calculation.
      - name: Compute next version
        id: bump
        run: |
          # Ensure we have the absolute latest tags for accurate version calculation.
          git fetch --tags origin
          bash scripts/semver_next.sh --emit-gh-output

      # Skip release if no commits found (should rarely happen).
      # Note: All commits now trigger at least a patch release.
      - name: Skip if no commits
        if: steps.bump.outputs.has_release != '1'
        run: |
          echo "No commits found since last tag â€” skipping release."

      # Configure Git user for automated tag creation.
      # Uses GitHub Actions bot identity for audit trail.
      - name: Configure git
        if: steps.bump.outputs.has_release == '1'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # Create and push the new version tag to trigger GoReleaser.
      # Tag creation must happen before GoReleaser runs.
      # Use atomic push to prevent race conditions with concurrent releases.
      - name: Create and push tag
        if: steps.bump.outputs.has_release == '1'
        run: |
          # Fetch latest tags to ensure we have the most recent state.
          git fetch --tags origin

          # Re-check if our calculated tag already exists (race condition protection).
          if git rev-parse "${{ steps.bump.outputs.next_tag }}" >/dev/null 2>&1; then
            echo "Tag ${{ steps.bump.outputs.next_tag }} already exists! Another release beat us to it."
            echo "This is expected behavior with concurrent PRs. Skipping release."
            exit 0
          fi

          # Create and push tag atomically.
          git tag "${{ steps.bump.outputs.next_tag }}"
          git push origin "${{ steps.bump.outputs.next_tag }}"

      # Run GoReleaser to build binaries and create GitHub release.
      # Only executes if semantic commits were found requiring a release.
      - name: GoReleaser
        if: steps.bump.outputs.has_release == '1'
        uses: goreleaser/goreleaser-action@v6
        with:
          version: v2.12.3 # Pin to specific version to avoid warnings.
          args: release --clean # Clean previous builds and create release.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Token for GitHub API access.
